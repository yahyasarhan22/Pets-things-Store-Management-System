{% extends "base.html" %}
{% block title %}Sales Analytics - Pets & Things{% endblock %}

{% block content %}
<section class="page-header">
  <div class="page-header-content">
    <div class="page-title-section">
      <h1 class="page-title"><span class="title-icon">üìä</span>Sales Analytics</h1>
      <p class="page-subtitle">Revenue trends and top categories</p>
    </div>

    <div class="header-actions">
      <form method="GET" action="{{ request.path }}" class="filter-form">
        <div class="filter-group">
          <label class="filter-label" for="branch_id">Branch</label>
          <select class="filter-select" id="branch_id" name="branch_id">
            <option value="">All Branches</option>
            {% for b in branches %}
              <option value="{{ b.branch_id }}" {% if selected_branch_id == b.branch_id %}selected{% endif %}>
                {{ b.branch_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label" for="date_from">From</label>
          <input class="filter-select" type="date" id="date_from" name="date_from" value="{{ date_from }}">
        </div>

        <div class="filter-group">
          <label class="filter-label" for="date_to">To</label>
          <input class="filter-select" type="date" id="date_to" name="date_to" value="{{ date_to }}">
        </div>

        <div class="filter-group">
          <label class="filter-label" for="group_by">Group</label>
          <select class="filter-select" id="group_by" name="group_by">
            <option value="day" {% if group_by == "day" %}selected{% endif %}>Daily</option>
            <option value="month" {% if group_by == "month" %}selected{% endif %}>Monthly</option>
          </select>
        </div>

        <div class="filter-buttons">
          <button type="submit" class="filter-btn apply-btn">Apply</button>
          <a href="{{ url_for('sales_analytics') }}" class="filter-btn reset-btn">Reset</a>
        </div>
      </form>
    </div>
  </div>
</section>

<section class="inventory-section">
  <div class="inventory-container">

    {% if error %}
      <div class="alert error"><span class="error-icon">‚ö†Ô∏è</span>{{ error }}</div>
    {% endif %}

    {% if summary %}
      <!-- KPI Cards (reuse your inv-card style) -->
      <section class="inventory-summary-section">
        <div class="inventory-summary-cards">
          <div class="inv-card">
            <div class="inv-card-icon">üí∞</div>
            <div class="inv-card-content">
              <div class="inv-card-label">Total Revenue</div>
              <div class="inv-card-value">{{ "%.2f"|format(summary.total_revenue) }} $</div>
            </div>
          </div>

          <div class="inv-card">
            <div class="inv-card-icon">üßæ</div>
            <div class="inv-card-content">
              <div class="inv-card-label">Sales Count</div>
              <div class="inv-card-value">{{ summary.sale_count }}</div>
            </div>
          </div>

          <div class="inv-card">
            <div class="inv-card-icon">üìå</div>
            <div class="inv-card-content">
              <div class="inv-card-label">Avg Sale</div>
              <div class="inv-card-value">{{ "%.2f"|format(summary.avg_sale) }} $</div>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    <!-- Chart -->
    <div class="table-card" style="margin-bottom:16px;">
      <div style="padding:16px;">
        <h2 style="margin-bottom:12px;">Revenue Trend</h2>
        <canvas id="revenueChart" height="90"></canvas>
      </div>
    </div>

    <!-- Top Categories -->
    <div class="table-card">
      <div class="table-wrapper">
        <table class="inventory-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Category</th>
              <th>Total Qty</th>
              <th>Total Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% if top_categories and top_categories|length > 0 %}
              {% for c in top_categories %}
                <tr>
                  <td><strong>{{ loop.index }}</strong></td>
                  <td>{{ c.category_name }}</td>
                  <td>{{ c.total_qty }}</td>
                  <td><strong>{{ "%.2f"|format(c.total_revenue) }} $</strong></td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" style="text-align:center; padding:16px;">No data for this range.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- Chart.js (simple CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ chart_labels|tojson }};
  const values = {{ chart_values|tojson }};

  const ctx = document.getElementById('revenueChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Revenue ($)',
        data: values,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
