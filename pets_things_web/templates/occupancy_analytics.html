{% extends "base.html" %}
{% block title %}Occupancy Analytics - Pets & Things{% endblock %}

{% block content %}
<section class="page-header">
  <div class="page-header-content">
    <div class="page-title-section">
      <h1 class="page-title">
        <span class="title-icon">ğŸ“Š</span>Occupancy Analytics
      </h1>
      <p class="page-subtitle">
        Available vs occupied rooms for a selected date range
      </p>
    </div>

    <div class="header-actions">
      <a href="{{ url_for('rooms_occupancy') }}" class="btn-secondary">ğŸ›ï¸ Occupancy View</a>
      <a href="{{ url_for('bookings_today') }}" class="btn-secondary">ğŸ“… Today</a>
      <a href="{{ url_for('admin_bookings') }}" class="btn-secondary">ğŸ“‹ Bookings</a>
    </div>
  </div>
</section>

<section class="inventory-section">
  <div class="inventory-container">

    {% if error %}
      <div class="alert error" style="margin-bottom:16px;">
        <span class="error-icon">âš ï¸</span>{{ error }}
      </div>
    {% endif %}

    <!-- Filters -->
    <div class="form-card" style="max-width:100%;">
      <div style="padding:24px;">
        <form method="GET" action="{{ url_for('occupancy_analytics') }}"
              style="display:grid; grid-template-columns: 1fr 1fr auto auto; gap:12px; align-items:end;">
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">ğŸ“… From</label>
            <input class="form-input" type="date" name="date_from" value="{{ date_from }}">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">ğŸ“… To</label>
            <input class="form-input" type="date" name="date_to" value="{{ date_to }}">
          </div>
          <button class="btn-primary" type="submit">Apply</button>
          <a class="btn-secondary" href="{{ url_for('occupancy_analytics') }}" style="text-align:center;">Reset</a>
        </form>
      </div>
    </div>

    <!-- KPI Cards -->
    <section class="inventory-summary-section">
      <div class="inventory-summary-cards">
        <div class="inv-card">
          <div class="inv-card-icon">ğŸ¨</div>
          <div class="inv-card-content">
            <div class="inv-card-label">Total Rooms</div>
            <div class="inv-card-value">{{ data.total_rooms }}</div>
          </div>
        </div>

        <div class="inv-card">
          <div class="inv-card-icon">ğŸ”’</div>
          <div class="inv-card-content">
            <div class="inv-card-label">Occupied</div>
            <div class="inv-card-value">{{ data.occupied_rooms }}</div>
          </div>
        </div>

        <div class="inv-card">
          <div class="inv-card-icon">âœ…</div>
          <div class="inv-card-content">
            <div class="inv-card-label">Available</div>
            <div class="inv-card-value">{{ data.available_rooms }}</div>
          </div>
        </div>

        <div class="inv-card">
          <div class="inv-card-icon">ğŸ“ˆ</div>
          <div class="inv-card-content">
            <div class="inv-card-label">Occupancy Rate</div>
            <div class="inv-card-value">
              {{ "%.1f"|format(data.occupancy_rate) }}%
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chart -->
    <div class="form-card" style="max-width:100%; margin-top:18px;">
      <div style="padding:24px;">
        <h2 style="margin-top:0; margin-bottom:12px;">Occupancy Breakdown</h2>

        <!-- FIXED SIZE CHART -->
        <div style="width:360px; height:260px; margin:0 auto;">
          <canvas id="occChart"></canvas>
        </div>

        <div class="info-notice" style="margin-top:16px;">
          <span class="info-icon">â„¹ï¸</span>
          <div class="info-text">
            A room is considered <strong>occupied</strong> if there exists a booking with
            <strong>booking_from &lt; selected_to</strong> and
            <strong>booking_to &gt; selected_from</strong>.
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const available = {{ data.available_rooms }};
  const occupied  = {{ data.occupied_rooms }};
  const total     = available + occupied;
  const percent   = total > 0 ? Math.round((occupied / total) * 100) : 0;

  // Center text plugin (draws percent + label inside the donut)
  const centerTextPlugin = {
    id: 'centerTextPlugin',
    afterDraw(chart, args, pluginOptions) {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      if (!meta || !meta.data || !meta.data[0]) return;

      const x = meta.data[0].x;
      const y = meta.data[0].y;

      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // Big percent
      ctx.font = '700 28px Arial';
      ctx.fillStyle = '#111';
      ctx.fillText(percent + '%', x, y - 8);

      // Small label
      ctx.font = '500 13px Arial';
      ctx.fillStyle = '#666';
      ctx.fillText('Occupied', x, y + 18);

      ctx.restore();
    }
  };

  const ctx = document.getElementById("occChart");

  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Available", "Occupied"],
      datasets: [{
        data: [available, occupied]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "72%",
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: function(context) {
              const val = context.raw || 0;
              const pct = total > 0 ? Math.round((val / total) * 100) : 0;
              return `${context.label}: ${val} (${pct}%)`;
            }
          }
        }
      }
    },
    plugins: [centerTextPlugin]
  });
</script>

{% endblock %}
